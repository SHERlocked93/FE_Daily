<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>太阳系</title>
    <style>
    * {
      margin: 0;
      padding: 0;
    }
    </style>
</head>
<body>
    <script type='module'>
    // todo 加上月球
    // todo 镜头拉近
    import * as THREE from '../libs/build/three.module.js'
    import { OrbitControls } from '../libs/jsm/controls/OrbitControls.js'
    
    const Planets = [
      { size: 300, position: 0, name: 'sun', revolutionSpeed: 0, selfRotationSpeed: .0004, planetRef: null, groupRef: null },
      { size: 15, position: 600, name: 'mercury', revolutionSpeed: .02, selfRotationSpeed: .004, planetRef: null, groupRef: null },
      { size: 40, position: 700, name: 'venus', revolutionSpeed: 0.003, selfRotationSpeed: .007, planetRef: null, groupRef: null },
      {
        size: 70, position: 1000, name: 'earth', revolutionSpeed: 0.009, selfRotationSpeed: .006, planetRef: null, groupRef: null, children: [
          { size: 70, position: 1000, name: 'moon', revolutionSpeed: 0.008, selfRotationSpeed: .003, planetRef: null, groupRef: null },
        ],
      },
      { size: 65, position: 1300, name: 'mars', revolutionSpeed: 0.002, selfRotationSpeed: .005, planetRef: null, groupRef: null },
      { size: 90, position: 1500, name: 'jupiter', revolutionSpeed: 0.001, selfRotationSpeed: .08, planetRef: null, groupRef: null },
      { size: 80, position: 1900, name: 'saturn', revolutionSpeed: 0.01, selfRotationSpeed: .5, planetRef: null, groupRef: null },
      { size: 70, position: 2200, name: 'neptune', revolutionSpeed: 0.016, selfRotationSpeed: .5, planetRef: null, groupRef: null },
    ]
    
    const scene = new THREE.Scene()
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 10000)  // 相机
    const textureLoader = new THREE.TextureLoader()
    textureLoader.load('./bg.jpg', texture => {
      const bg = new THREE.WebGLCubeRenderTarget(texture.image.height)
      bg.fromEquirectangularTexture(renderer, texture)
      scene.background = bg.texture
    })
    
    camera.position.set(1700, 1500, 1400)
    camera.lookAt(scene.position)
    
    const renderer = new THREE.WebGLRenderer({ antialias: true })
    renderer.setClearColor(new THREE.Color(0x000000))
    renderer.setSize(window.innerWidth, window.innerHeight)
    
    const axes = new THREE.AxesHelper(1080)
    scene.add(axes)
    
    // 环境光 后面要换成点光源
    const light = new THREE.AmbientLight(0xffffff)
    scene.add(light)
    
    // 设置星球大小与位置
    const addPlanet = planet => {
      const { size, position, name } = planet
      const planeGroup = new THREE.Group()
      planet.groupRef = planeGroup
      scene.add(planeGroup)
      textureLoader.load(`./${ name }.jpg`, texture => {
        const sphereGeometry = new THREE.SphereGeometry(size, 256, 256)
        const sphereMaterial = new THREE.MeshPhongMaterial({ map: texture })
        const mesh = new THREE.Mesh(sphereGeometry, sphereMaterial)
        planet.planetRef = mesh
        mesh.position.set(position, 0, 0)   // 行星散步在x轴上
        planeGroup.add(mesh)
        
        const circleCurve = new THREE.ArcCurve(0, 0, position, 0, 2 * Math.PI)
        const points = circleCurve.getPoints(256)
        const orbitGeometry = new THREE.BufferGeometry().setFromPoints(points)
        const orbitMaterial = new THREE.LineBasicMaterial({ color: 0xeeeeee })
        const orbitLine = new THREE.Line(orbitGeometry, orbitMaterial)
        orbitLine.rotateX(Math.PI / 2)
        scene.add(orbitLine)
      })
    }
    
    const handleRotation = ({ groupRef, planetRef, revolutionSpeed, selfRotationSpeed }) => {
      if (!planetRef) return
      groupRef.rotation.y += revolutionSpeed  // 公转
      planetRef.rotation.y += selfRotationSpeed  // 自转
    }
    
    const animate = () => {
      Planets.forEach(handleRotation)
      renderer.render(scene, camera)
      requestAnimationFrame(animate)
    }
    
    const controls = new OrbitControls(camera, renderer.domElement)
    controls.addEventListener('change', () => {
      renderer.render(scene, camera)
    })
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight
      camera.updateProjectionMatrix()
      renderer.setSize(window.innerWidth, window.innerHeight)
    })
    
    document.body.appendChild(renderer.domElement)
    Planets.forEach(addPlanet)
    animate()
    renderer.render(scene, camera)
    </script>
</body>
</html>
